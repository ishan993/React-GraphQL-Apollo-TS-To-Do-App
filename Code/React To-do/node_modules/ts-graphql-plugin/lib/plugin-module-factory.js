"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var ts = require("typescript/lib/tsserverlibrary");
var graphql_language_service_adapter_1 = require("./graphql-language-service-adapter");
var language_service_proxy_builder_1 = require("./language-service-proxy-builder");
var schema_json_manager_1 = require("./schema-json-manager");
var ts_util_1 = require("./ts-util");
function create(info) {
    var logger = function (msg) { return info.project.projectService.logger.info(msg); };
    logger('ts-graphql-plugin config: ' + JSON.stringify(info.config));
    var getNode = function (fileName, position) {
        return ts_util_1.findNode(info.languageService.getProgram().getSourceFile(fileName), position);
    };
    var getAllNodes = function (fileName, cond) {
        var s = info.languageService.getProgram().getSourceFile(fileName);
        return ts_util_1.findAllNodes(s, cond);
    };
    var getLineAndChar = function (fileName, position) {
        var s = info.languageService.getProgram().getSourceFile(fileName);
        return ts.getLineAndCharacterOfPosition(s, position);
    };
    var schemaManager = new schema_json_manager_1.SchamaJsonManager(info);
    var helper = {
        getNode: getNode,
        getAllNodes: getAllNodes,
        getLineAndChar: getLineAndChar,
    };
    var schema = schemaManager.getSchema();
    var tag = info.config.tag;
    var adapter = new graphql_language_service_adapter_1.GraphQLLanguageServiceAdapter(helper, { schema: schema, logger: logger, tag: tag });
    var proxy = new language_service_proxy_builder_1.LanguageServiceProxyBuilder(info)
        .wrap('getCompletionsAtPosition', function (delegate) { return adapter.getCompletionAtPosition.bind(adapter, delegate); })
        .wrap('getSemanticDiagnostics', function (delegate) { return adapter.getSemanticDiagnostics.bind(adapter, delegate); })
        .build();
    schemaManager.registerOnChange(adapter.updateSchema.bind(adapter));
    schemaManager.startWatch();
    return proxy;
}
var moduleFactory = function (mod) {
    return { create: create };
};
exports.default = moduleFactory;
//# sourceMappingURL=plugin-module-factory.js.map